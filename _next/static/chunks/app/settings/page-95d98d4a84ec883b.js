(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[938],{803:function(){},5897:function(e,t,n){Promise.resolve().then(n.bind(n,5109))},2561:function(e,t,n){"use strict";n.d(t,{DY:function(){return A},EP:function(){return h},Jl:function(){return x},Lj:function(){return v},UM:function(){return f},Xs:function(){return w},ZG:function(){return b},ZJ:function(){return p},Zi:function(){return y},aU:function(){return R},bN:function(){return T},eK:function(){return S},fC:function(){return g},k8:function(){return O},lZ:function(){return j},mF:function(){return N},qn:function(){return I},yv:function(){return M},zK:function(){return m}});var r=n(2040),a=n.n(r);let i=null,s=null,o="audio-indexer-db",c="database",l="directoryHandle";async function u(){return s||(s=await a()({locateFile:e=>"https://sql.js.org/dist/".concat(e)}))}function d(){return new Promise((e,t)=>{let n=indexedDB.open(o,1);n.onerror=()=>t("Error opening IndexedDB"),n.onsuccess=()=>e(n.result),n.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(c)||t.createObjectStore(c),t.objectStoreNames.contains(l)||t.createObjectStore(l)}})}async function E(){let e=await d();return new Promise((t,n)=>{let r=e.transaction(c,"readonly").objectStore(c).get("db");r.onerror=()=>n("Error loading from IndexedDB"),r.onsuccess=()=>t(r.result)})}async function f(){if(!i)return;let e=i.export();(await d()).transaction(c,"readwrite").objectStore(c).put(e,"db")}async function m(){if(i)return i;let e=await u(),t=await E();return(i=t?new e.Database(t):new e.Database)&&i.run("\n    CREATE TABLE IF NOT EXISTS artists (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT UNIQUE,\n      imageUrl TEXT\n    );\n    CREATE TABLE IF NOT EXISTS albums (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT,\n      artist_id INTEGER,\n      imageUrl TEXT,\n      FOREIGN KEY(artist_id) REFERENCES artists(id),\n      UNIQUE(name, artist_id)\n    );\n    CREATE TABLE IF NOT EXISTS tracks (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      title TEXT,\n      track TEXT,\n      path TEXT UNIQUE,\n      lastModified INTEGER,\n      size INTEGER,\n      album_id INTEGER,\n      artist_id INTEGER,\n      FOREIGN KEY(album_id) REFERENCES albums(id),\n      FOREIGN KEY(artist_id) REFERENCES artists(id)\n    );\n  "),i}function p(e){if(i){i.exec("BEGIN TRANSACTION");try{let t=i.prepare("INSERT OR IGNORE INTO tracks (title, track, path, lastModified, size, album_id, artist_id) VALUES (?, ?, ?, ?, ?, ?, ?)");for(let n of e){let e=function(e){if(!i)throw Error("Database not initialized");let t=i.prepare("SELECT id FROM artists WHERE name = ?");if(t.bind([e]),t.step()){let e=t.get()[0];return t.free(),e}t.free();let n=i.prepare("INSERT INTO artists (name) VALUES (?)");return n.run([e]),n.free(),i.exec("SELECT last_insert_rowid()")[0].values[0][0]}(n.artist),r=function(e,t){if(!i)throw Error("Database not initialized");let n=i.prepare("SELECT id FROM albums WHERE name = ? AND artist_id = ?");if(n.bind([e,t]),n.step()){let e=n.get()[0];return n.free(),e}n.free();let r=i.prepare("INSERT INTO albums (name, artist_id) VALUES (?, ?)");return r.run([e,t]),r.free(),i.exec("SELECT last_insert_rowid()")[0].values[0][0]}(n.album,e);t.run([n.title,n.track,n.path,n.lastModified,n.size,r,e])}t.free(),i.exec("COMMIT")}catch(e){throw console.error("Bulk insert failed, rolling back.",e),i.exec("ROLLBACK"),e}}}function h(e){if(!i)return;let t=i.prepare("UPDATE artists SET imageUrl = ? WHERE name = ?");t.run([e.imageUrl,e.name]),t.free()}function b(e){if(!i)return;let t=i.prepare("SELECT id FROM artists WHERE name = ?");if(t.bind([e.artistName]),!t.step()){t.free();return}let n=t.get()[0];t.free();let r=i.prepare("UPDATE albums SET imageUrl = ? WHERE name = ? AND artist_id = ?");r.run([e.imageUrl,e.name,n]),r.free()}function g(){if(!i)return[];let e=i.prepare("SELECT id, name, imageUrl FROM artists ORDER BY name"),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function R(e){if(!i)return null;let t=i.prepare("SELECT id, name, imageUrl FROM artists WHERE name = ?");if(t.bind([e]),t.step()){let e=t.getAsObject();return t.free(),e}return t.free(),null}function S(e,t){if(!i)return null;let n=i.prepare("\n      SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n      FROM albums a\n      JOIN artists r ON a.artist_id = r.id\n      WHERE a.name = ? AND r.name = ?\n  ");if(n.bind([e,t]),n.step()){let e=n.getAsObject();return n.free(),e}return n.free(),null}function T(e){if(!i)return[];let t=i.prepare("SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n     FROM albums a\n     JOIN artists r ON a.artist_id = r.id\n     WHERE r.name = ?\n     ORDER BY a.name");t.bind([e]);let n=[];for(;t.step();)n.push(t.getAsObject());return t.free(),n}function N(e,t){if(!i)return[];let n=i.prepare("\n      SELECT t.id, t.title, t.track, t.album_id, t.artist_id, r.name as artistName, a.name as albumName\n      FROM tracks t\n      JOIN artists r ON t.artist_id = r.id\n      JOIN albums a ON t.album_id = a.id\n      WHERE a.name = ? AND r.name = ?\n      ORDER BY CAST(t.track AS INTEGER)\n  ");n.bind([e,t]);let r=[];for(;n.step();)r.push(n.getAsObject());return n.free(),r}function O(){if(!i)return[];let e=i.prepare("\n      SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n      FROM albums a\n      JOIN artists r ON a.artist_id = r.id\n      ORDER BY a.name\n  "),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function x(){if(!i)return[];let e=i.prepare("\n      SELECT t.id, t.title, t.track, t.album_id, t.artist_id, r.name as artistName, a.name as albumName\n      FROM tracks t\n      JOIN artists r ON t.artist_id = r.id\n      JOIN albums a ON t.album_id = a.id\n      ORDER BY r.name, a.name, CAST(t.track AS INTEGER)\n  "),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function j(){if(!i)return{};let e=i.prepare("SELECT path, lastModified, size FROM tracks"),t={};for(;e.step();){let n=e.get(),r=n[0],a=n[1],i=n[2];t[r]={lastModified:a,size:i}}return e.free(),t}function I(){if(!i)return 0;let e=i.exec("SELECT COUNT(*) FROM artists");return 0!==e.length&&e[0].values[0]?e[0].values[0][0]:0}function w(){return i?i.export():null}async function y(e){let t=await u();i&&i.close(),i=new t.Database(e),await f()}async function v(){return i&&(i.close(),i=null),new Promise((e,t)=>{let n=indexedDB.deleteDatabase(o);n.onerror=()=>t("Error deleting database"),n.onsuccess=()=>e()})}async function A(e){(await d()).transaction(l,"readwrite").objectStore(l).put(e,"directoryHandle")}async function M(){let e=await d();return new Promise((t,n)=>{let r=e.transaction(l,"readonly").objectStore(l).get("directoryHandle");r.onerror=()=>n("Error loading directory handle from IndexedDB"),r.onsuccess=()=>t(r.result)})}},7611:function(e,t,n){"use strict";n.d(t,{r:function(){return i},z:function(){return s}});let r="my-music-library-settings",a={scanMode:"on-launch",scanIntervalHours:6};function i(){try{let e=localStorage.getItem(r);if(e){let t=JSON.parse(e);if(t.scanMode&&t.scanIntervalHours)return t}}catch(e){console.error("Failed to load settings from localStorage:",e)}return a}function s(e){try{localStorage.setItem(r,JSON.stringify(e))}catch(e){console.error("Failed to save settings to localStorage:",e)}}},5109:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return d}});var r=n(7437),a=n(7138),i=n(2265),s=n(2561),o=n(7611);let c=[];function l(e){let t={timestamp:new Date().toISOString(),message:e};c.push(t),c.length>1e3&&c.shift()}var u=n(357);function d(){let[e,t]=(0,i.useState)(!1),[d,E]=(0,i.useState)(0),[f,m]=(0,i.useState)([]),[p,h]=(0,i.useState)(null),[b,g]=(0,i.useState)({scanMode:"on-launch",scanIntervalHours:6}),[R,S]=(0,i.useState)("Idle"),[T,N]=(0,i.useState)({total:0,new:0,modified:0,unchanged:0,processed:0}),[O,x]=(0,i.useState)(!1),j=(0,i.useRef)(null);(0,i.useEffect)(()=>(t("showDirectoryPicker"in window),g((0,o.r)()),(0,s.zK)().then(()=>{E((0,s.qn)())}),j.current=new Worker(n.tu(new URL(n.p+n.u(551),n.b))),j.current.onmessage=async e=>{let{type:t,message:n,stats:r,tracks:a,processed:i,total:o}=e.data;switch(t){case"status":S(n),l("Status: ".concat(n)),m(e=>[...e,"Status: ".concat(n)]);break;case"scan-progress":N(e=>({...e,...r}));break;case"parse-progress":N(e=>({...e,processed:i,total:o}));break;case"tracks-added":console.time("Bulk inserting tracks batch"),(0,s.ZJ)(a),await (0,s.UM)(),console.timeEnd("Bulk inserting tracks batch"),E((0,s.qn)());break;case"scan-complete":x(!1),S("Scan complete."),N(e=>({...e,...r})),l("Scan complete: ".concat(JSON.stringify(r))),m(e=>[...e,"Scan complete: ".concat(JSON.stringify(r))])}},()=>{var e;null===(e=j.current)||void 0===e||e.terminate()}),[]);let I=e=>{let t={...b,...e};g(t),(0,o.z)(t)},w=async()=>{x(!0),S("Initializing scan..."),N({total:0,new:0,modified:0,unchanged:0,processed:0});try{var e;let t=await (0,s.yv)();t||(t=await window.showDirectoryPicker(),await (0,s.DY)(t));let n=(0,s.lZ)();null===(e=j.current)||void 0===e||e.postMessage({type:"scan",directoryHandle:t,trackIndex:n})}catch(e){x(!1),e instanceof DOMException&&"AbortError"===e.name?S("Directory selection cancelled."):(S("An error occurred during scan initiation."),console.error("Error starting scan:",e))}},y=async()=>{if(p){let e=new FileReader;e.onload=async e=>{var t;if(null===(t=e.target)||void 0===t?void 0:t.result){let t=new Uint8Array(e.target.result);await (0,s.Zi)(t),alert("Database restored. The application will reload."),window.location.reload()}},e.readAsArrayBuffer(p)}};return(0,r.jsxs)("main",{style:{paddingBottom:"8rem"},children:[(0,r.jsx)("h1",{children:"Settings"}),(0,r.jsxs)("p",{children:["Artists Scanned: ",d]}),(0,r.jsx)("hr",{}),(0,r.jsx)("h2",{children:"File Scanning"}),e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:w,disabled:O,children:O?"Scanning...":"Manual Scan"}),(0,r.jsxs)("div",{style:{marginTop:"1rem"},children:[(0,r.jsx)("h4",{children:"Scan Options"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{type:"radio",id:"manual",name:"scanMode",value:"manual",checked:"manual"===b.scanMode,onChange:()=>I({scanMode:"manual"})}),(0,r.jsx)("label",{htmlFor:"manual",children:" Manual scan only"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{type:"radio",id:"on-launch",name:"scanMode",value:"on-launch",checked:"on-launch"===b.scanMode,onChange:()=>I({scanMode:"on-launch"})}),(0,r.jsx)("label",{htmlFor:"on-launch",children:" Scan on application launch"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{type:"radio",id:"periodic",name:"scanMode",value:"periodic",checked:"periodic"===b.scanMode,onChange:()=>I({scanMode:"periodic"})}),(0,r.jsx)("label",{htmlFor:"periodic",children:" Scan periodically"}),"periodic"===b.scanMode&&(0,r.jsxs)("select",{value:b.scanIntervalHours,onChange:e=>I({scanIntervalHours:parseInt(e.target.value,10)}),style:{marginLeft:"10px"},children:[(0,r.jsx)("option",{value:1,children:"Every 1 hour"}),(0,r.jsx)("option",{value:6,children:"Every 6 hours"}),(0,r.jsx)("option",{value:24,children:"Every 24 hours"})]})]})]}),(0,r.jsx)("h4",{children:"Scan Status"}),(0,r.jsx)("p",{children:R}),O&&(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{children:["Total Files: ",T.total," | New: ",T.new," | Modified: ",T.modified," | Unchanged: ",T.unchanged]}),(0,r.jsxs)("p",{children:["Metadata Parsing: ",T.processed," / ",T.total-T.unchanged]})]})]}):(0,r.jsx)("p",{children:"The File System Access API is not supported in your browser."}),(0,r.jsx)("button",{onClick:()=>{let e=new Blob([c.map(e=>"".concat(e.timestamp," - ").concat(e.message)).join("\n")],{type:"text/plain"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="scan-logs.txt",n.click(),URL.revokeObjectURL(t)},children:"Export Logs"}),(0,r.jsx)("div",{style:{height:"200px",overflowY:"auto",border:"1px solid #ccc",padding:"10px",marginTop:"10px"},children:f.map((e,t)=>(0,r.jsx)("div",{children:e},t))}),(0,r.jsx)("hr",{}),(0,r.jsx)("h2",{children:"Testing"}),(0,r.jsx)(a.default,{href:"/test",children:"Metadata Speed Test"}),(0,r.jsx)("hr",{}),(0,r.jsx)("h2",{children:"Database Management"}),(0,r.jsx)("button",{onClick:()=>{let e=(0,s.Xs)();if(e){let t=new Blob([new Uint8Array(e)],{type:"application/octet-stream"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="audio-indexer.db",r.click(),URL.revokeObjectURL(n)}},children:"Backup Database"}),(0,r.jsx)("br",{}),(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"file",onChange:e=>{var t;return h((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}}),(0,r.jsx)("button",{onClick:y,disabled:!p,children:"Restore Database"}),(0,r.jsx)("hr",{}),(0,r.jsx)("button",{onClick:async()=>{window.confirm("Are you sure you want to delete the database?")&&(await (0,s.Lj)(),alert("Database deleted. The application will reload."),window.location.reload())},children:"Delete Database"}),u.env.NEXT_PUBLIC_RELEASE_VERSION&&(0,r.jsx)("div",{style:{textAlign:"center",marginTop:"2rem",color:"#888"},children:(0,r.jsx)("p",{children:u.env.NEXT_PUBLIC_RELEASE_VERSION})})]})}}},function(e){e.O(0,[218,251,231,918,971,190,744],function(){return e(e.s=5897)}),_N_E=e.O()}]);