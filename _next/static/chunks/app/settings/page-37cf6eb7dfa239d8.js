(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[938],{803:function(){},5897:function(e,t,r){Promise.resolve().then(r.bind(r,8972))},2561:function(e,t,r){"use strict";r.d(t,{EP:function(){return S},Jl:function(){return y},Lj:function(){return C},Qj:function(){return N},UM:function(){return f},Xs:function(){return _},ZG:function(){return g},ZJ:function(){return T},Zi:function(){return x},aU:function(){return h},bN:function(){return I},eK:function(){return w},fC:function(){return O},gG:function(){return R},jB:function(){return A},k8:function(){return k},mF:function(){return j},qn:function(){return U},zK:function(){return m}});var n=r(2040),a=r.n(n);let i=null,s=null,l="audio-indexer-db",u="database",o="directoryHandle";async function c(){return s||(s=await a()({locateFile:e=>"https://sql.js.org/dist/".concat(e)}))}function d(){return new Promise((e,t)=>{let r=indexedDB.open(l,1);r.onerror=()=>t("Error opening IndexedDB"),r.onsuccess=()=>e(r.result),r.onupgradeneeded=e=>{let t=e.target.result;t.objectStoreNames.contains(u)||t.createObjectStore(u),t.objectStoreNames.contains(o)||t.createObjectStore(o)}})}async function E(){let e=await d();return new Promise((t,r)=>{let n=e.transaction(u,"readonly").objectStore(u).get("db");n.onerror=()=>r("Error loading from IndexedDB"),n.onsuccess=()=>t(n.result)})}async function f(){if(!i)return;let e=i.export();(await d()).transaction(u,"readwrite").objectStore(u).put(e,"db")}async function m(){if(i)return i;let e=await c(),t=await E();return(i=t?new e.Database(t):new e.Database)&&i.run("\n    CREATE TABLE IF NOT EXISTS artists (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT UNIQUE,\n      imageUrl TEXT\n    );\n    CREATE TABLE IF NOT EXISTS albums (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT,\n      artist_id INTEGER,\n      imageUrl TEXT,\n      FOREIGN KEY(artist_id) REFERENCES artists(id),\n      UNIQUE(name, artist_id)\n    );\n    CREATE TABLE IF NOT EXISTS tracks (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      title TEXT,\n      track TEXT,\n      path TEXT UNIQUE,\n      album_id INTEGER,\n      artist_id INTEGER,\n      FOREIGN KEY(album_id) REFERENCES albums(id),\n      FOREIGN KEY(artist_id) REFERENCES artists(id)\n    );\n  "),i}function p(e){if(!i)throw Error("Database not initialized");let t=i.prepare("SELECT id FROM artists WHERE name = ?");if(t.bind([e]),t.step()){let e=t.get()[0];return t.free(),e}t.free();let r=i.prepare("INSERT INTO artists (name) VALUES (?)");return r.run([e]),r.free(),i.exec("SELECT last_insert_rowid()")[0].values[0][0]}function b(e,t){if(!i)throw Error("Database not initialized");let r=i.prepare("SELECT id FROM albums WHERE name = ? AND artist_id = ?");if(r.bind([e,t]),r.step()){let e=r.get()[0];return r.free(),e}r.free();let n=i.prepare("INSERT INTO albums (name, artist_id) VALUES (?, ?)");return n.run([e,t]),n.free(),i.exec("SELECT last_insert_rowid()")[0].values[0][0]}function R(e){if(!i)return;let t=p(e.artist),r=b(e.album,t),n=i.prepare("INSERT INTO tracks (title, track, path, album_id, artist_id) VALUES (?, ?, ?, ?, ?)");n.run([e.title,e.track,e.path,r,t]),n.free()}function T(e){if(i){i.exec("BEGIN TRANSACTION");try{let t=i.prepare("INSERT OR IGNORE INTO tracks (title, track, path, album_id, artist_id) VALUES (?, ?, ?, ?, ?)");for(let r of e){let e=p(r.artist),n=b(r.album,e);t.run([r.title,r.track,r.path,n,e])}t.free(),i.exec("COMMIT")}catch(e){throw console.error("Bulk insert failed, rolling back.",e),i.exec("ROLLBACK"),e}}}function N(e){if(!i)return;let t=i.prepare("DELETE FROM tracks WHERE path = ?");t.run([e]),t.free()}function S(e){if(!i)return;let t=i.prepare("UPDATE artists SET imageUrl = ? WHERE name = ?");t.run([e.imageUrl,e.name]),t.free()}function g(e){if(!i)return;let t=i.prepare("SELECT id FROM artists WHERE name = ?");if(t.bind([e.artistName]),!t.step()){t.free();return}let r=t.get()[0];t.free();let n=i.prepare("UPDATE albums SET imageUrl = ? WHERE name = ? AND artist_id = ?");n.run([e.imageUrl,e.name,r]),n.free()}function O(){if(!i)return[];let e=i.prepare("SELECT id, name, imageUrl FROM artists ORDER BY name"),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function h(e){if(!i)return null;let t=i.prepare("SELECT id, name, imageUrl FROM artists WHERE name = ?");if(t.bind([e]),t.step()){let e=t.getAsObject();return t.free(),e}return t.free(),null}function w(e,t){if(!i)return null;let r=i.prepare("\n      SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n      FROM albums a\n      JOIN artists r ON a.artist_id = r.id\n      WHERE a.name = ? AND r.name = ?\n  ");if(r.bind([e,t]),r.step()){let e=r.getAsObject();return r.free(),e}return r.free(),null}function I(e){if(!i)return[];let t=i.prepare("SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n     FROM albums a\n     JOIN artists r ON a.artist_id = r.id\n     WHERE r.name = ?\n     ORDER BY a.name");t.bind([e]);let r=[];for(;t.step();)r.push(t.getAsObject());return t.free(),r}function j(e,t){if(!i)return[];let r=i.prepare("\n      SELECT t.id, t.title, t.track, t.album_id, t.artist_id, r.name as artistName, a.name as albumName\n      FROM tracks t\n      JOIN artists r ON t.artist_id = r.id\n      JOIN albums a ON t.album_id = a.id\n      WHERE a.name = ? AND r.name = ?\n      ORDER BY CAST(t.track AS INTEGER)\n  ");r.bind([e,t]);let n=[];for(;r.step();)n.push(r.getAsObject());return r.free(),n}function k(){if(!i)return[];let e=i.prepare("\n      SELECT a.id, a.name, a.artist_id, a.imageUrl, r.name as artistName\n      FROM albums a\n      JOIN artists r ON a.artist_id = r.id\n      ORDER BY a.name\n  "),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function y(){if(!i)return[];let e=i.prepare("\n      SELECT t.id, t.title, t.track, t.album_id, t.artist_id, r.name as artistName, a.name as albumName\n      FROM tracks t\n      JOIN artists r ON t.artist_id = r.id\n      JOIN albums a ON t.album_id = a.id\n      ORDER BY r.name, a.name, CAST(t.track AS INTEGER)\n  "),t=[];for(;e.step();)t.push(e.getAsObject());return e.free(),t}function A(){if(!i)return new Set;let e=i.prepare("SELECT path FROM tracks"),t=new Set;for(;e.step();)t.add(e.get()[0]);return e.free(),t}function U(){if(!i)return 0;let e=i.exec("SELECT COUNT(*) FROM artists");return 0!==e.length&&e[0].values[0]?e[0].values[0][0]:0}function _(){return i?i.export():null}async function x(e){let t=await c();i&&i.close(),i=new t.Database(e),await f()}async function C(){return i&&(i.close(),i=null),new Promise((e,t)=>{let r=indexedDB.deleteDatabase(l);r.onerror=()=>t("Error deleting database"),r.onsuccess=()=>e()})}},8972:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return l}});var n=r(7437),a=r(2265),i=r(2561),s=r(357);function l(){let[e,t]=(0,a.useState)(!1),[l,u]=(0,a.useState)(!1),[o,c]=(0,a.useState)(0),[d,E]=(0,a.useState)(0),[f,m]=(0,a.useState)(null),[p,b]=(0,a.useState)(!1),[R,T]=(0,a.useState)("Inactive"),[N,S]=(0,a.useState)(0),g=(0,a.useRef)(null),O=(0,a.useRef)(null);(0,a.useEffect)(()=>(t("showDirectoryPicker"in window),(0,i.zK)().then(()=>{S((0,i.qn)())}),g.current=new Worker(r.tu(new URL(r.p+r.u(714),r.b))),g.current.onmessage=async e=>{if("progress"===e.data.type)c(e.data.payload);else if("complete"===e.data.type){for(let t of e.data.payload)(0,i.gG)(t);await (0,i.UM)(),S((0,i.qn)()),u(!1)}else"error"===e.data.type&&(console.error(e.data.payload),u(!1))},O.current=new Worker(r.tu(new URL(r.p+r.u(69),r.b))),O.current.onmessage=async e=>{let{type:t,payload:r}=e.data;if("state"===t)T(r),b("scanning"===r);else if("added"===t)console.time("Bulk inserting tracks"),(0,i.ZJ)(r),await (0,i.UM)(),console.timeEnd("Bulk inserting tracks"),S((0,i.qn)());else if("deleted"===t){for(let e of r)(0,i.Qj)(e);await (0,i.UM)(),S((0,i.qn)())}},()=>{var e,t;null===(e=g.current)||void 0===e||e.terminate(),null===(t=O.current)||void 0===t||t.terminate()}),[]);let h=async()=>{try{let e=await window.showDirectoryPicker();u(!0),c(0);let t=[],n=[];for await(let r of e.values())"directory"===r.kind?t.push(r):"file"===r.kind&&n.push(r);let a=[{values:async function*(){for(let e of n)yield e}},...t];E(a.length);let s=(0,i.jB)(),l=[],o=[],d=0;await new Promise(e=>{let t=0,n=(r,i)=>{r.onmessage=i=>{let s=i.data.payload;l.push(...s),d++,c(d),t<a.length?n(r,a[t++]):(r.terminate(),o.splice(o.indexOf(r),1),0===o.length&&e())},r.postMessage({directoryHandle:i,knownFilePaths:s})};for(let e=0;e<4&&e<a.length;e++){let e=new Worker(r.tu(new URL(r.p+r.u(444),r.b)));o.push(e),n(e,a[t++])}0===a.length&&e()}),console.time("Bulk inserting tracks"),(0,i.ZJ)(l),await (0,i.UM)(),console.timeEnd("Bulk inserting tracks"),S((0,i.qn)()),u(!1)}catch(e){console.error("Error during directory selection or scanning:",e),u(!1)}},w=async()=>{if(f){let e=new FileReader;e.onload=async e=>{var t;if(null===(t=e.target)||void 0===t?void 0:t.result){let t=new Uint8Array(e.target.result);await (0,i.Zi)(t),alert("Database restored successfully. The application will now reload."),window.location.reload()}},e.readAsArrayBuffer(f)}};return(0,n.jsxs)("main",{style:{paddingBottom:"5rem"},children:[(0,n.jsx)("h1",{children:"Settings"}),(0,n.jsx)("h2",{children:"Library Management"}),e?(0,n.jsx)("button",{onClick:h,disabled:l,children:l?"Scanning...":"Scan Directory"}):(0,n.jsx)("p",{children:"The File System Access API is not supported in your browser."}),l&&(0,n.jsx)("progress",{value:o,max:d}),(0,n.jsxs)("p",{children:["Artists Scanned: ",N]}),(0,n.jsx)("hr",{}),(0,n.jsx)("h2",{children:"Background Scanning"}),(0,n.jsx)("p",{children:(0,n.jsx)("i",{children:"Continuous background scanning is temporarily disabled."})}),(0,n.jsx)("button",{disabled:!0,children:"Select Directory & Start Scanning"}),(0,n.jsx)("button",{disabled:!0,children:"Stop Scanning"}),(0,n.jsxs)("p",{children:["Status: ",R]}),(0,n.jsx)("hr",{}),(0,n.jsx)("h2",{children:"Database Management"}),(0,n.jsx)("button",{onClick:()=>{let e=(0,i.Xs)();if(e){let t=new Blob([new Uint8Array(e)],{type:"application/octet-stream"}),r=URL.createObjectURL(t),n=document.createElement("a");n.href=r,n.download="audio-indexer.db",n.click(),URL.revokeObjectURL(r)}},children:"Backup Database"}),(0,n.jsx)("br",{}),(0,n.jsx)("br",{}),(0,n.jsx)("input",{type:"file",onChange:e=>{var t;return m((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)}}),(0,n.jsx)("button",{onClick:w,disabled:!f,children:"Restore Database"}),(0,n.jsx)("hr",{}),(0,n.jsx)("button",{onClick:async()=>{window.confirm("Are you sure you want to delete the database?")&&(await (0,i.Lj)(),alert("Database deleted successfully. The application will now reload."),window.location.reload())},children:"Delete Database"}),s.env.NEXT_PUBLIC_RELEASE_VERSION&&(0,n.jsx)("div",{style:{textAlign:"center",marginTop:"2rem",color:"#888"},children:(0,n.jsx)("p",{children:s.env.NEXT_PUBLIC_RELEASE_VERSION})})]})}}},function(e){e.O(0,[218,251,128,971,190,744],function(){return e(e.s=5897)}),_N_E=e.O()}]);